#include <LiquidCrystal.h>

LiquidCrystal lcd(8, 9, 4, 5, 6, 7);

const int FrequencyPin = 2;
const int DutyPin = 3;
const int PWMPin = 4;
const int PedalPin = 5;
const int MosfetPin = 6;

float PeriodMosfet = 0;
float FrequencyMosfet = 1;
float PercentageMosfet = 5;
int AnalogPedal = 0;
float DutyRead;
int PWMValue = 0;

unsigned long CurrentTime = 0;
unsigned long PreviousTime = 0;

// NEW: Timing variables for LCD
unsigned long previousLCDMillis = 0;
const long lcdInterval = 200; // Update LCD every 200ms

void setup() {
  pinMode(MosfetPin, OUTPUT);
  Serial.begin(115200);
  lcd.begin(16, 2);
}

void loop() {
  CurrentTime = millis();

  // 1. NON-BLOCKING LCD UPDATE
  if (CurrentTime - previousLCDMillis >= lcdInterval) {
    previousLCDMillis = CurrentTime;
    
    // Instead of lcd.clear() which causes flicker, we overwrite specific positions
    lcd.setCursor(0, 0);
    lcd.print("PWM: ");
    lcd.print(AnalogPedal);
    lcd.print("   "); // Spaces clear trailing digits from previous higher values

    lcd.setCursor(8, 0);
    lcd.print("Frq:");
    lcd.print((int)FrequencyMosfet);
    lcd.print("  ");

    lcd.setCursor(0, 1);
    lcd.print("Duty: ");
    lcd.print(PercentageMosfet);
    lcd.print("    ");
  }

  // 2. SENSOR CALCULATIONS (Keep outside timing for responsiveness)
  FrequencyMosfet = map(analogRead(FrequencyPin), 0, 1023, 60, 2);
  AnalogPedal = map(analogRead(PedalPin), 0, 1024, 0, 255);
  DutyRead = map(analogRead(DutyPin), 0, 1023, 350, 10);
  PercentageMosfet = DutyRead / 1000.0;
  PeriodMosfet = 1000.0 / FrequencyMosfet;

  // 3. SOLENOID LOGIC
  if (AnalogPedal > 50) {
    if (CurrentTime - PreviousTime >= PeriodMosfet) {
      PreviousTime += PeriodMosfet;
      PWMValue = map(AnalogPedal, 0, 255, 0, 275);
      if (PWMValue >= 255){
        PWMValue = 255;
      }
      analogWrite(MosfetPin, PWMValue);
    }
    if (CurrentTime - PreviousTime >= (PeriodMosfet * PercentageMosfet)) {
      analogWrite(MosfetPin, 0);
    }
  } else {
    analogWrite(MosfetPin, 0); // Explicitly kill PWM
    digitalWrite(MosfetPin, LOW);
    PreviousTime = CurrentTime;
  }
}
