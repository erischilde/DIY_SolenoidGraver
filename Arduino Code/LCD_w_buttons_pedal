#include <LiquidCrystal.h>

LiquidCrystal lcd(8, 9, 4, 5, 6, 7);

int menuCounter = 0;
const int totalOptions = 3;
String menuOptions[totalOptions] = {"1. Direct Power", "2. Direct Freq", "3. Pulses"};

int Mode = 0;

// Debounce variables
int lastButtonState = -1;     // -1 means no button pressed
unsigned long lastDebounceTime = 0;
unsigned long debounceDelay = 50; 

void setup() {
  Serial.begin(115200);
  lcd.begin(16, 2);
  displayMenu();
}

void loop() {
  int currentButton = get_debounced_button();

  // Only act on the "Press" event (when state changes from -1 to a button value)
  static int previousButton = -1;
  if (currentButton != previousButton && currentButton != -1) {
    handleInput(currentButton);
  }
  previousButton = currentButton;
}

// Function to convert Analog A0 to a button ID with debouncing
int get_debounced_button() {
  int rawReading = analogRead(0);
  int buttonFound = -1;

  if (rawReading < 60) buttonFound = 0;      // Right
  else if (rawReading < 200) buttonFound = 1; // Up
  else if (rawReading < 400) buttonFound = 2; // Down
  else if (rawReading < 600) buttonFound = 3; // Left
  else if (rawReading < 800) buttonFound = 4; // Select

  // If the reading changed (noise or press), reset the timer
  if (buttonFound != lastButtonState) {
    lastDebounceTime = millis();
  }

  lastButtonState = buttonFound;

  // Only return the button value if it has been stable for longer than debounceDelay
  if ((millis() - lastDebounceTime) > debounceDelay) {
    return buttonFound;
  }
  
  return -1;
}

void handleInput(int btn) {
  switch (btn) {
    case 1: // Up
      menuCounter = (menuCounter - 1 + totalOptions) % totalOptions;
      displayMenu();
      break;
    case 2: // Down
      menuCounter = (menuCounter + 1) % totalOptions;
      displayMenu();
      break;
    case 4: // Select
      executeAction();
      displayMenu();
      break;
  }
}

void displayMenu() {
  lcd.clear();
  lcd.setCursor(0, 0);
  lcd.print("> " + menuOptions[menuCounter]);
  lcd.setCursor(0, 1);
  lcd.print("  " + menuOptions[(menuCounter + 1) % totalOptions]);
  Serial.println(menuCounter);
}

void executeAction() {
  lcd.clear();
  lcd.print("Executing...");
  //lcd.setCursor(0, 1);
  //lcd.print(menuOptions[menuCounter]);
  
  switch (menuCounter){
    case 0:
      lcd.clear();
      lcd.setCursor(0, 1);
      lcd.print("I would be doing something here");
      //FrequencyPot();
      break;
    case 1:
      lcd.clear();
      lcd.setCursor(0, 1);
      lcd.print("DirectStuff");
      //DirectFrequency();
      break;
    case 2:
      lcd.clear();
      lcd.setCursor(0, 1);
      lcd.print("fukinPulses");
      //Pulses();
      break;
  }
  delay(1000);
}

/*
void WriteOnLCD(){          //Function that will be called to write the information on the LCD

  lcd.setCursor(5,0);
  if (Mode==1){
    lcd.print("Pulses     ");
  }
  if(Mode==0){
    lcd.print("Potenti    ");
  }
  if(Mode==2){
    lcd.print("Direct    ");
  }
  lcd.setCursor(0,1);
  lcd.print("Freq:  ");
  lcd.setCursor(7,1);
  lcd.print(FrequencyMosfet);
}


void Pulses(){
      // read the state of the switch into a local variable
    CurrentTime = millis();
    //Serial.println(PercentageMosfet);

    FrequencyMosfet = map(analogRead(FrequencyPin),0,1023,1,50);
    AnalogPedal = map(round(analogRead(A3)),0,1024,0,100);
    float DutyRead = (map(analogRead(PercentagePin),0,1023,10,350));
    PercentageMosfet = DutyRead/1000;;

  
    
    PeriodMosfet = (1000/FrequencyMosfet);
    //Serial.println(PeriodMosfet);
    if (AnalogPedal>20){
      
      
      if (CurrentTime - StartOfPulses <= TimeForPulses/2){

        if(CurrentTime - PreviousTime >= PeriodMosfet){
          PreviousTime+=PeriodMosfet;
          if(MosfetState==LOW){
            MosfetState=HIGH;
            digitalWrite(MosfetPin, MosfetState);

          }
        }
      
        if(CurrentTime - PreviousTime >= (PeriodMosfet*PercentageMosfet)/100) {
          if(MosfetState==HIGH){
            MosfetState=LOW;
            digitalWrite(MosfetPin, MosfetState);
            

          }
        }
      }
      else if(CurrentTime - StartOfPulses >= TimeForPulses){
        StartOfPulses=CurrentTime;
        
        digitalWrite(MosfetPin,LOW);
      }
      else{
        digitalWrite(MosfetPin,LOW);
      }
    }
    else{
      digitalWrite(MosfetPin,LOW);
      StartOfPulses=CurrentTime;
      WriteOnLCD(); 
    }
  }      //Finish mode 0 (Pulses in a second)
}

void FrequencyPot(){
//    if (Mode==0){                   //Frequency selected on the potentiometers
    CurrentTime = millis();
    
    FrequencyMosfet = map(analogRead(FrequencyPin),0,1023,2,50);
    AnalogPedal = map(round(analogRead(A3)),0,1024,0,255);
    //Serial.println(PercentageMosfet);
    float DutyRead = (map(analogRead(PercentagePin),0,1023,10,350));
    PercentageMosfet = DutyRead/1000;
    
    PeriodMosfet = (1000/FrequencyMosfet);
    
    if (AnalogPedal>20){
      if(CurrentTime - PreviousTime >= PeriodMosfet){
        PreviousTime+=PeriodMosfet;
        if(MosfetState==LOW){
          MosfetState=HIGH;
          analogWrite(MosfetPin, AnalogPedal);
        }
      }
    
      if(CurrentTime - PreviousTime >= (PeriodMosfet*PercentageMosfet)) {
        if(MosfetState==HIGH){
          MosfetState=LOW;
          analogWrite(MosfetPin, 0);
        }
      }
    }
    else{
      digitalWrite(MosfetPin,LOW);
      StartOfPulses=CurrentTime;
      WriteOnLCD();      
    }    
}      //Finish mode 1 (Direct Potentiometer Mode)


void DirectFrequency(){
//    if (Mode==2){                   //Frequency selected on the potentiometers
  CurrentTime = millis();
  
  FrequencyMosfet = map(analogRead(FrequencyPin),0,1023,1,50);
  AnalogPedal = map(round(analogRead(A3)),0,1024,0,255);
  //Serial.println(PercentageMosfet);
  float DutyRead = (map(analogRead(PercentagePin),0,1023,10,350));
  PercentageMosfet = DutyRead/1000;
  
  PeriodMosfet = (1000/FrequencyMosfet);
  
  if (AnalogPedal>20){
    if(CurrentTime - PreviousTime >= PeriodMosfet){
      PreviousTime+=PeriodMosfet;
      if(MosfetState==LOW){
        MosfetState=HIGH;
        digitalWrite(MosfetPin, MosfetState);
      }
    }
  
    if(CurrentTime - PreviousTime >= (PeriodMosfet*PercentageMosfet)) {
      if(MosfetState==HIGH){
        MosfetState=LOW;
        digitalWrite(MosfetPin, MosfetState);
      }
    }
  }
  else{
    digitalWrite(MosfetPin,LOW);
    StartOfPulses=CurrentTime;
    WriteOnLCD();       
  }    
}      //Finish mode 2 (Direct Frequency)
*/
